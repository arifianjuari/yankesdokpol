name: Deploy to Production

on:
  push:
    branches: [ main ]


env:
  HOST: biddokkesjatim.org
  PORT: 65002
  USERNAME: u609399718
  TARGET_DIR: /domains/biddokkesjatim.org/public_html/yankesdokpol

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: Add known hosts
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        ssh-keyscan -p ${{ env.PORT }} -H ${{ env.HOST }} >> ~/.ssh/known_hosts
        chmod 644 ~/.ssh/known_hosts
    
    - name: Test SFTP connection
      run: |
        echo "put -r . ${{ env.TARGET_DIR }}" | sftp -P ${{ env.PORT }} -b - ${{ env.USERNAME }}@${{ env.HOST }}:/domains/biddokkesjatim.org/public_html/
    
    - name: Deploy using SFTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ env.HOST }}
        server-dir: ${{ env.TARGET_DIR }}
        username: ${{ env.USERNAME }}
        password: ${{ secrets.SFTP_PASSWORD }}
        port: ${{ env.PORT }}
        exclude: |
          **/.git/**
          **/.github/**
          **/.gitignore
          **/.env
          **/node_modules/**
          **/README.md
          **/LICENSE
    
    - name: Set file permissions
      run: |
        ssh -p ${{ env.PORT }} ${{ env.USERNAME }}@${{ env.HOST }} "
          find ${{ env.TARGET_DIR }} -type d -exec chmod 755 {} \;
          find ${{ env.TARGET_DIR }} -type f -exec chmod 644 {} \;
          chmod -R 777 ${{ env.TARGET_DIR }}/uploads
          chmod -R 777 ${{ env.TARGET_DIR }}/dokumentasi
          chmod 755 ${{ env.TARGET_DIR }}
        "
