name: Deploy to Production

on:
  push:
    branches: [ main ]


env:
  HOST: biddokkesjatim.org
  USERNAME: u609399718
  TARGET_DIR: /home/u609399718/domains/biddokkesjatim.org/public_html/yankesdokpol

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: Add known hosts
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        ssh-keyscan -H ${{ env.HOST }} >> ~/.ssh/known_hosts
        chmod 644 ~/.ssh/known_hosts
    
    - name: Test SSH connection
      run: |
        ssh -v -o StrictHostKeyChecking=no ${{ env.USERNAME }}@${{ env.HOST }} 'echo "SSH Connection Successful"'
    
    - name: Create target directory if not exists
      run: |
        ssh ${{ env.USERNAME }}@${{ env.HOST }} "
          mkdir -p ${{ env.TARGET_DIR }}
          chmod -R 755 ${{ env.TARGET_DIR }}
          mkdir -p ${{ env.TARGET_DIR }}/uploads
          mkdir -p ${{ env.TARGET_DIR }}/dokumentasi
          chmod -R 777 ${{ env.TARGET_DIR }}/uploads
          chmod -R 777 ${{ env.TARGET_DIR }}/dokumentasi
        "
    
    - name: Deploy using rsync
      run: |
        rsync -avz --delete \
          --exclude='.git' \
          --exclude='.github' \
          --exclude='.gitignore' \
          --exclude='.env' \
          --exclude='node_modules' \
          ./ ${{ env.USERNAME }}@${{ env.HOST }}:${{ env.TARGET_DIR }}/
    
    - name: Set file permissions
      run: |
        ssh ${{ env.USERNAME }}@${{ env.HOST }} "
          find ${{ env.TARGET_DIR }} -type d -exec chmod 755 {} \;
          find ${{ env.TARGET_DIR }} -type f -exec chmod 644 {} \;
          chmod -R 777 ${{ env.TARGET_DIR }}/uploads
          chmod -R 777 ${{ env.TARGET_DIR }}/dokumentasi
          chmod 755 ${{ env.TARGET_DIR }}
        "
