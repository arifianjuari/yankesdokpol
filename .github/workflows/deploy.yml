name: Deploy to Production

on:
  push:
    branches: [ main ]

env:
  FTP_SERVER: biddokkesjatim.org
  FTP_PORT: 21
  FTP_USERNAME: u609399718
  FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
  LOCAL_DIR: .
  REMOTE_DIR: /domains/biddokkesjatim.org/public_html/yankesdokpol

defaults:
  run:
    working-directory: ${{ github.workspace }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Install lftp
      run: |
        sudo apt-get update
        sudo apt-get install -y lftp
        
    - name: List files
      run: ls -la
      
    - name: Create deployment script
      run: |
        cat > deploy.lftp << 'EOL'
        set ftp:ssl-allow no
        set ssl:verify-certificate no
        set sftp:auto-confirm yes
        open -u $FTP_USERNAME,$FTP_PASSWORD -p $FTP_PORT $FTP_SERVER
        
        # Create directories if they don't exist
        mkdir -p $REMOTE_DIR
        cd $REMOTE_DIR
        
        # Mirror local to remote
        mirror --reverse --delete --verbose \
          --exclude .git/ \
          --exclude .github/ \
          --exclude .gitignore \
          --exclude .env \
          --exclude node_modules/ \
          $LOCAL_DIR/ .
        
        # Set permissions
        chmod -R 755 .
        chmod -R 777 uploads/
        chmod -R 777 dokumentasi/
        
        bye
        EOL
        
        # Make script executable
        chmod +x deploy.lftp
        
    - name: Run deployment
      run: |
        lftp -f deploy.lftp
      env:
        FTP_SERVER: ${{ env.FTP_SERVER }}
        FTP_PORT: ${{ env.FTP_PORT }}
        FTP_USERNAME: ${{ env.FTP_USERNAME }}
        FTP_PASSWORD: ${{ env.FTP_PASSWORD }}
        LOCAL_DIR: ${{ env.LOCAL_DIR }}
        REMOTE_DIR: ${{ env.REMOTE_DIR }}
